<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="Content-Type">
  <title>cloudRmpi Manual</title>
  <link rel="stylesheet" href="cloudrmpi.css">
</head>
<body>
<div id="content">
<br>
<h2 style="text-align: center;">cloudRmpi Manual</h2>
<br>
<h4 style="text-align: center;">April 2012, Version 1.1<br>
</h4>
<h4 style="text-align: center;">Barnet Wagman <a
 href="mailto:bw@norble.com">bw@norbl.com</a></h4>
<br>
<span style="font-style: italic;">cloudRmpi</span> is means for doing
parallel processing in R, using MPI on a cloud-based network.&nbsp; It
currently supports the use of Amazon's EC2 cloud computer service.
<span style="font-style: italic;">cloudRmpi</span> provides a mechanism
to launch and manage a cloud-based
network and to access an R session on the network's master MPI node
(using the rreval package). <span style="font-style: italic;">cloudRmpi
</span>should
work
with
any
MPI
based
R
package
(it has been tested with Rmpi,
npRmpi, and snow).<br>
<br>
<hr style="width: 100%; height: 2px;"><br>
<span style="font-weight: bold;">Contents<br>
</span>
<ol>
  <li><a href="#1._Overview">Overview</a><br>
  </li>
  <li><a href="#2._RequirementsPrelims">Requirements/Prelims</a></li>
  <li><a href="#3._How_to_use_cloudRmpi"><span
 style="font-weight: bold;">How to
use </span><span style="font-style: italic; font-weight: normal;"><span
 style="font-weight: bold;">cloudRmpi </span></span></a></li>
  <li><a href="#4._Choosing_an_instance_type">Choosing an instance
type</a></li>
  <li><a href="#5._Costs">Costs</a><br>
  </li>
  <li><a href="#6._Security">Security</a></li>
  <li><a href="#7._Dependencies">Dependencies</a></li>
  <li><a href="#8._Machine_images">Machine
Images</a></li>
  <li><a><span style="font-style: italic;"></span></a><a
 href="#9._Architecture">Architecture</a></li>
  <li><a href="#10._Handling_problems">Handling problems</a><br>
  </li>
</ol>
<br>
<hr style="width: 100%; height: 2px;"><br>
<h3><a name="1._Overview"></a>1. Overview</h3>
'Cloud' computing services provide a relatively low cost way of doing
parallel processing. The <span style="font-style: italic;">cloudRmpi </span>package
provides
a
means
for
doing
parallel
processing
in
R
using
these
kinds
of
facilities.&nbsp;
It
currently
supports
the
creation
and
use
of
networks
running
Open
MPI
on
Amazon's
cloud computer service,
EC2.&nbsp; We hope to add support for other vendors' cloud computing
services in the near future.<br>
<br>
There are two main elements in the <span style="font-style: italic;">cloudRmpi
</span>package: an application for creating and managing EC2 networks
(that support Open MPI and R), and functions for accessing an R session
on the master node of the network.&nbsp; <br>
<br>
The network manager is a java application, launched from within R with
the <span style="font-family: monospace;">ppe.launchNetworkManager() </span>function
(see
<a href="#3._How_to_use_cloudRmpi">How to use cloudRmpi</a>,
below). ('ppe' stands for 'parallel processing&nbsp; with EC2.&nbsp;
The network manager has also been released in a non-R package, <a
 href="http://norbl.com/ppe-ompi/ppe-ompi.html">ppe-ompi</a>.)<br>
<br>
A network launched&nbsp; with th<span style="font-style: italic;"></span>e
cloudRmpi
network
manager
contains
one
host
that
is
designated
the
Open
MPI
master
node.&nbsp;
That
master
node
runs
an
R
session
that
is
accessible
remotely
using
functions
in
the <span style="font-style: italic;">rreval</span>
package.&nbsp; Using the
access functions is covered in <a href="#3._How_to_use_cloudRmpi">How
to use cloudRmpi</a>, below. <br>
<br>
Note that public cloud computing services like EC2 are commercial
products.&nbsp; See the <a href="#5._Costs">Costs</a> section below
for a discussion of the costs involved in using <span
 style="font-style: italic;">cloudRmpi</span>.<br>
<br>
<br>
<h3><a name="2._RequirementsPrelims"></a>2. Requirements/Prelims</h3>
<span style="font-style: italic;"></span><span
 style="font-style: italic;"></span>Besides installing the <span
 style="font-style: italic;">cloudRmpi</span> package in R, there are
few other requirements.<br>
<br>
<ol>
  <li>Java (&gt;= 1.6)<br>
    <br>
The Java
interpreter must be in your execution path.&nbsp; To test whether you
have an accessible copy of Java, at a command line type<br>
    <div style="margin-left: 40px;"> <br>
    <span style="font-family: monospace;">java -version</span><br>
    </div>
    <br>
If Java is installed, you should get something like<br>
    <div style="margin-left: 40px;"><br>
    <span style="font-family: monospace;">java version "1.6.0_26"</span><br
 style="font-family: monospace;">
    <span style="font-family: monospace;">Java(TM) SE Runtime
Environment (build 1.6.0_26-b03)</span><br
 style="font-family: monospace;">
    <span style="font-family: monospace;">Java HotSpot(TM) 64-Bit
Server VM (build 20.1-b02, mixed mode)</span><br>
    <br>
    </div>
(Why Java? See the <span style="font-style: italic;"><a>Architecture</a>
    </span>section
below.)<br>
&nbsp; </li>
  <li>An <span class="normal_link "><a href="http://aws.amazon.com/">AWS</a>
account.</span><br>
    <span class="normal_link ">&nbsp; </span></li>
  <li>Once you have an account<br>
&nbsp; </li>
  <ol>
    <li><span class="normal_link">Register
for the EC2 service; you can
do this via <a
 href="https://aws-portal.amazon.com/gp/aws/manageYourAccount/">AWS
Account Management</a>.</span>
&nbsp; <span class="normal_link"> </span><br>
      <span class="normal_link">&nbsp; </span></li>
    <li><span class="normal_link"></span><span class="normal_link">Create
and
download
an
EC2
RSA
keypair
using
the



















      <a href="https://console.aws.amazon.com/ec2/home">AWS
Management
Console</a>
(EC2 tab, NETWORK &amp; SECURITY -&gt; Key Pair). You will need the key
pair name the first time you use <span style="font-style: italic;">cloudRmpi</span>.</span><br>
      <span class="normal_link">&nbsp; </span></li>
    <li><span class="normal_link">Get
the following strings from
your Amazon account <a
 href="https://aws-portal.amazon.com/gp/aws/developer/account/index.html?ie=UTF8&amp;action=access-key">Security
Credentials</a> page.</span><br>
      <br>
      <div style="margin-left: 40px;"><span class="normal_link">Account
number</span><br>
      <span class="normal_link">Access Key ID</span><br>
      <span class="normal_link">Secret Access Key</span><br>
      </div>
      <br>
The 'Access Key ID' and 'Secret Access
Key'&nbsp; are in the&nbsp; 'Access Credentials' section, in the
'Access Keys' tab. You will need these strings the first time you use <span
 style="font-style: italic;">cloudRmpi</span>. </li>
  </ol>
</ol>
<div style="margin-left: 40px;">
</div>
<br>
<h3><a name="3._How_to_use_cloudRmpi"></a>3. How to use cloudRmpi</h3>
<h4 style="text-decoration: underline;">3.1 Creating a network</h4>
<span style="font-weight: bold;">3.1.1 Launch the ec2 network manager</span><br>
<br>
In a local R session<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">library(cloudRmpi)</span><br>
</div>
<br>
Launch the network manager:<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">ppe.launchNetworkManager()</span><br>
</div>
<br>
<br>
<span style="font-weight: bold; text-decoration: underline;">The first
time time you launch the network manager</span><br>
<br>
<div style="margin-left: 40px;"><span style="font-weight: bold;">(a)
Required parameters<br>
<br>
</span>You'll need to supply some
values that are required to launch ec2 instances.&nbsp; From the top
menu bar, use <span style="font-family: monospace;">Edit -&gt; EC2
parameters</span>, i.e.<br>
<br>
<img style="width: 682px; height: 216px;" alt=""
 src="ec2_man_ec2_param_mi_cropped.png"><br>
<br>
This brings up the "Required Ec2 Parameters" entry window:<br>
<br>
<br>
</div>
<div style="margin-left: 40px;">
<div style="margin-left: 40px;"><img
 style="width: 650px; height: 513px;" alt=""
 src="req_ec2_params_shrunk.jpg"><br>
</div>
<br>
These&nbsp; values will be stored in a configuration
file named <tt>.ppe-config</tt>
that
will be created in your home directory. You can change these values
using the <tt>Edit -&gt; EC2 Parameters</tt> menu item in the main
network manager
window or by editing the file directly. <br>
<br>
<span style="font-weight: bold;">(b) Optional
billing authorization</span><br>
<br>
We charge $0.03 per hour per instance for use of our most recent
machine images (AMIs).&nbsp; This is billed through Amazon but requires
separate authorization.&nbsp; For details and&nbsp; to authorize
billling, select <span style="font-family: monospace;">Account -&gt;
Authorize instance billing</span> from top menubar of the main network
manager<span style="font-style: italic;"> </span>window.<br>
<br>
<br>
<span style="font-weight: bold;">(c) Optional AWS client parameters</span><br>
<br>
If you access the internet though a proxy server, you <span
 style="font-style: italic;">may</span> need to set some Amazon client
configuration parameters before you can launch ec2 instances.&nbsp; You
can set any of these parameters via <span
 style="font-family: monospace;">Edit -&gt; AWS client parameters</span>
in top menu bar of the<span style="font-style: italic;"> </span>main<span
 style="font-style: italic;"> n</span>etwork manager<span
 style="font-style: italic;"> </span>window.&nbsp; See&nbsp;<a
 href="http://docs.amazonwebservices.com/AWSSdkDocsJava/latest/DeveloperGuide/section-client-configuration.html">Amazon's
documentation</a> for details on these parameters. If in doubt, we
suggest that you first trying to create a network without setting any
of these parameters.&nbsp; <br>
</div>
<br>
<br>
<br>
<span style="font-weight: bold;">3.1.2 Specify and create a network</span><br>
<br>
<div style="margin-left: 40px;"><img
 style="width: 629px; height: 205px;" alt=""
 src="../../../cbp_201203/documents/doc/ppe-ompi/ec2_man_create_network_mi_cropped.png"><br>
</div>
<br>
<span style="text-decoration: underline;"><br>
Select an <a href="http://aws.amazon.com/ec2/instance-types/">instance
type</a> </span><br>
For most purposes (other than testing),
you'll probably want to choose <span style="font-family: monospace;">cc1.4xlarge</span>
or <span style="font-family: monospace;">cc2.8xlarge</span> because
they can be run in&nbsp; a <a
 href="http://aws.amazon.com/ec2/hpc-applications/">cluster placement
group</a>.&nbsp; See&nbsp;<a href="#4._Choosing_an_instance_type">Choosing
an
Instance
Type</a> for more information.&nbsp; If
you choose one of these instance types, the application manager will
launch <span style="font-family: monospace;"></span><span
 style="font-style: italic;"></span>your
instances in a cluster placement group.<br>
<br>
<br>
<div style="margin-left: 40px;"><img
 style="width: 871px; height: 403px;" alt="" src="spec_network._top.png"><br>
</div>
<br>
<span style="text-decoration: underline;">Choose a <a
 href="http://aws.amazon.com/amis/">machine image</a> (AMI)</span><br>
AMIs that are not compatible with the selected instance type are
disabled.<br>
<br>
<span style="text-decoration: underline;">Specify the <a
 href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">availability
zone</a></span>.&nbsp; <br>
If you've choosen an instance type that supports clusters,<span
 style="font-family: monospace;"> </span>select 'Use any
zone';&nbsp; <span style="font-family: monospace;"></span>your
instances will be launched in <a>cluster
group</a> and a cluster group always runs in a single zone.&nbsp;
Otherwise, specifying a zone
insures that your
instances are not spread across multiple zones (which may or may not be
worth something re communications).&nbsp; However, if you are using
an&nbsp;<a href="http://aws.amazon.com/ebs/">Amazon Elastic Block Store
(EBS)</a> for persistent storage, you must launch your instances in the
availability zone where the EBS volume resides.&nbsp;&nbsp; An EBS
volume can only
be attached to an instance in its availability zone. (An AMI resides in
a <a
 href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">region</a>
and can be launched in any availability zone within that region.)<br>
<br>
<div style="margin-left: 40px;"><img
 style="width: 800px; height: 246px;" alt=""
 src="../../../cbp_201203/documents/doc/ppe-ompi/network_spec_gui_bot.png"><br>
</div>
<br>
<span style="text-decoration: underline;">Specify the security group</span><br>
If 'Default' is selected, <span style="font-style: italic;">cloudRmpi</span>
will create an appropriate one-time security group.&nbsp; See <a>Security</a>&nbsp;
for
details.
<br>
<br>
<span style="text-decoration: underline;">Specify the keypair</span><br>
Normally, select the keypair that you specified in the "RSA keypair
name" field of the "Required Ec2 Parameters" entry form.<br>
<br>
<span style="text-decoration: underline;">Spot instances</span><br>
If you want to use <a href="http://aws.amazon.com/ec2/spot-instances/">spot
instances</a>,
specify a spot price.&nbsp; (Make sure that you understand the
limitations of spot instances.)&nbsp; Note that as of 2011, all
instance
types are available as spots.<br>
<br>
<span style="text-decoration: underline;">Network name</span><br>
<span style="font-style: italic;">cloudRmpi </span>will automatically
generate a unique network name (you can change it).<br>
<br>
<span style="text-decoration: underline;">Slots per host</span><br>
<span style="text-decoration: underline;"></span>The number of slots
per host is automatically generated based on
the
instance type selected (you can change it).&nbsp; This value is used to
create the ompi hostfile.<br>
<br>
<span style="text-decoration: underline;">Specify the number of
instances<br>
<br>
<br>
</span>When you hit 'Continue' you'll have a chance to check the
network's&nbsp; specification
before it's launched.<br>
<br>
<h4 style="text-decoration: underline;">3.2 Using the network</h4>
<span style="text-decoration: underline;"></span>The network is ready
for use when its status is "running":<br>
<br>
<br>
<div style="margin-left: 40px;"><img
 style="width: 441px; height: 229px;" alt="" src="running_enm_ul.png"><br>
</div>
<br>
<br>
Note that Amazon tools (such as the <a
 href="https://aws.amazon.com/console/">Amazon Management Console</a>)
will show
your instances with status 'running' before the EC2 network manager
does . AWS's monitoring lists instances as 'running' as soon as they
are
launched, even before the operating system has finished booting. After
launching a network, network manager<span style="font-style: italic;"> </span>waits
for
the
operating
system
to
boot
and
then
performs
some
configuration.&nbsp;
It
does
not
show
the
network's
status
as
'running'
until
all
instances
are
booted
and
configured.<br>
<br>
Occasionally an instance will not launch successfully.&nbsp; You may
want to use the Amazon Management Console to monitor this - watch for
instances that get 'stuck' with "Status Checks" equal to "initializing
...".&nbsp; If an instance does not respond, after ten minutes you'll
be given the option of terminating it and proceeding.<br>
<br>
Connect to an R session running on the master node of the network:<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">ppe.startClient()</span><br>
</div>
<br>
('ppe' stands for 'parallel processing on EC2').&nbsp; <br>
<br>
(On a few occasions, <span style="font-family: monospace;">ppe.startClient()</span>&nbsp;
has
<span style="font-family: monospace;"></span>returned
<span style="font-family: monospace;">java.net.SocketException:
Connection </span><span class="Apple-style-span"
 style="border-collapse: separate; color: rgb(0, 0, 0); font-family: monospace; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
 class="Apple-style-span"
 style="font-family: Monospace; font-size: 13px; line-height: 17px; white-space: pre-wrap;"></span></span><span
 style="font-family: monospace;">reset</span> ...,&nbsp; which
indicates a
transmission error.&nbsp; If this happens, just try <span
 style="font-family: monospace;">ppe.startClient() </span>again.)<br>
<br>
Once you're connected,
you can evaluate expressions. E.g.<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">re(1+1)</span><br>
</div>
<br>
will return the value 2.&nbsp; An expression like <br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">re(a
&lt;-
seq(1,100)^2)</span><br>
</div>
<br>
will create an object named 'a' in the remote R session <span
 style="font-style: italic;">and</span> return the value of the
expression.<br>
<br>
To retrieve an expression from the remote session<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">re(a)</span><br>
</div>
<br>
or to assign it locally<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">aa
&lt;-
re(a)</span><br>
</div>
<br>
To upload an object<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">z
&lt;- sin(pi)</span><br style="font-family: monospace;">
<span style="font-family: monospace;">upo(z)</span><br>
</div>
<br>
(To move large objects, you may want to use the scp transfer functions,
<span style="font-family: monospace;">scpUpload()</span> and<br>
<span style="font-family: monospace;">scpDownload()</span>; see the
package documentation for details.)<br>
<br>
You can evaluate any expression in the remote session, including things
like<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">re(library(npRmpi))</span><br
 style="font-family: monospace;">
<span style="font-family: monospace;">re(ls())</span><br>
</div>
<br>
It is perfectly acceptable to upload functions, e.g.<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">fn
&lt;-
function(x)
{
quantile(x,seq(0,1,0.1))
}</span><br style="font-family: monospace;">
<span style="font-family: monospace;">upo(fn)</span><br>
</div>
<br>
Errors
will be handled gracefully, e.g.<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">re(lss())</span><br>
</div>
<br>
yields the error message<br>
<br>
<div style="margin-left: 40px;"><span class="Apple-style-span"
 style="border-collapse: separate; color: rgb(0, 0, 0); font-family: Arial; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; line-height: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; font-size: medium;"><span
 class="Apple-style-span"
 style="font-family: Monospace; font-size: 13px; line-height: 17px; white-space: pre-wrap;">
<pre tabindex="0" class="GD40030CLR"
 style="border-style: none; margin: 0px; font-family: Monospace; font-size: 10pt ! important; outline-style: none; white-space: pre-wrap ! important; line-height: 1.3;">&lt;simpleError in eval(expr, envir, enclos): could not find function "lss"&gt;</pre>
<br>
</span></span></div>
Note that all expression evaluations and assignments in the remote R
session are performed in <span style="font-family: monospace;">.GlobalEnv</span>
(the top level of the scope hierarchy).&nbsp; Of course you can
explicitly specify other environments (e.g. <span
 style="font-family: monospace;">re(assign(x="a",value=1234,envir=some.other.envir))</span>).<br>
<br>
When your done using the network, close the connection with<br>
<br>
<div style="margin-left: 40px; font-family: monospace;">ppe.closeClient()<br>
</div>
<br>
and, more importantly, terminate the network using the application
manager<br>
<div style="margin-left: 40px;"><img
 style="width: 436px; height: 126px;" alt=""
 src="terminate_reboot_detail.png"><br>
</div>
<br>
<br>
Remember that Amazon will be charging you for your EC2 instances until
you terminate them.&nbsp; You can also terminate your network with <span
 style="font-family: monospace;">ppe.terminateNetwork()</span> or with
the <a href="https://aws.amazon.com/console/">Amazon Management Console</a>.<br>
<br>
<h4 style="text-decoration: underline;">3.3 Accessing the network with
ssh</h4>
Alternatively, you can access your ec2 network via ssh.&nbsp; EC2
instances are accessible using you RSA key (but not via password). E.g.<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">ssh
-i
your_keypair_file.pem
ec2-user@ec2-174-129-172-112.compute-1.amazon.com</span><br>
</div>
<br>
where <span style="font-family: monospace;">ec2-174-129-172-112.compute-1.amazon.com
</span>is the URL of the network's master node.&nbsp; (You can get the
master node's URL from the network manager or with the R function <span
 style="font-family: monospace;">ppe.getMasterNodeURL(...)</span>. See
the <span style="font-family: monospace;">cloudRmpi </span>package
documentation for details.)<br>
<br>
Once you've ssh'd into the master node you can start a standard R
session from the command line.<br>
<br>
<br>
<span style="font-weight: bold; text-decoration: underline;">3.4 Using
EBS
for
persistent storage</span><br>
<br>
When a EC2 instance is terminated, anything that was written the to
disk is lost.&nbsp; However, you can attach persisent disk space to an
EC2 instance using what AWS terms an <a
 href="http://aws.amazon.com/ebs/">Amazon Elastic
Block Store (EBS)</a>.&nbsp; The operating system sees an EBS as device
(like a hard drive).&nbsp; <span style="font-style: italic;">ppe-ompi </span>provides
support
for
using
EBS.<br>
<br>
You can create an EBS volume with the <a
 href="https://console.aws.amazon.com/">AWS Management Console</a> (EC2
tab -&gt; Navigation sidebar Elastic Block Store: Volumes).&nbsp; You
do not need to have any instances running to create volumes.<br>
<br>
To use an EBS volume with a specific EC2 instance, you must 'attach' it
to the volume and then mount&nbsp; it (like any other Unix
volume).&nbsp; You can get a list of your EBS volumes and their
statuses from the ec2 network manager i.e.<br>
<br>
<div style="margin-left: 40px;"><img
 style="width: 367px; height: 133px;" alt=""
 src="volumes_mi_cropped.png"><br>
</div>
<div style="margin-left: 40px;"><br>
</div>
You can attach the volume using an instance popup menu e.g.<br>
<br>
<div style="margin-left: 40px;"><img
 style="width: 772px; height: 204px;" alt=""
 src="volume_popup_cropped.png"><br>
</div>
<br>
(You can also list and attach volumes using the AWS Management Console.)<br>
<br>
To make an EBS volume accessible,&nbsp; you'll need to use Linux
commands.&nbsp; You can ssh to your instance e.g.<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">ssh
-i
your_keypair_file.pem
ec2-user@ec2-174-129-172-112.compute-1.amazon.com</span><br>
</div>
<br>
or you can use an ssh shell that is built into <span
 style="font-style: italic;">ppe-ompi</span>.<br>
<br>
A newly created volume does not have a files system.&nbsp;&nbsp; After
attaching it to an instance, you'll need to use <span
 style="font-family: monospace;"></span> the standard Linux utility <span
 style="font-family: monospace;">mkfs</span><span
 style="font-family: Arial,sans-serif;">, e.g.<br>
<br>
</span>
<div style="margin-left: 40px;"><span
 style="font-family: Arial,sans-serif;"><span
 style="font-family: monospace;">sudo mkfs -t ext3 /def/sdf</span></span><br>
<span style="font-family: Arial,sans-serif;"></span></div>
<span style="font-family: Arial,sans-serif;"><br>
</span>And of course you need to mount the device<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">sudo
mount
/def/sdf
/home/ec2-user/your-mount-point</span><br>
</div>
<br>
See <a
 href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/ebs-using-volumes.html">Amazon's
documentation</a> for details.<br>
<br>
Note that an EBS volume resides in what Amazon terms an <span
 style="text-decoration: underline;"><span
 style="text-decoration: underline;"></span></span><a
 href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html">availability
zone</a>, and can only be attached to an EC2 instance running in that
zone.&nbsp; So if you intend to attach an EBS volume to an instance in
a <span style="font-style: italic;">ppe-ompi</span> network, you must
launch the network in the EBS volume's zone (see <a>Specify
and
create
a
network</a>,
above).&nbsp; An AMI resides in a 'region', which contains multiple
availability zones, and all <span style="font-style: italic;">ppe-ompi</span>
AMIs reside in the <span style="font-family: monospace;">us-east-1</span>
region.&nbsp; So to use an EBS volume with <span
 style="font-style: italic;">ppe-ompi</span>, it must be created in one
of the us-east-1 zones.<br>
<br>
<br>
<h3><a name="4._Choosing_an_instance_type"></a>4. Choosing an instance
type</h3>
Amazon's EC2 service supplies computers with various processor types
and
memory configurations, which it terms <a
 href="http://aws.amazon.com/ec2/instance-types/">instances</a>.&nbsp;
While you can use <span style="font-style: italic;">cloudRmpi</span>
with any instance type, there is a substantial advantage to using
instance types <span style="font-family: monospace;">cc1.4xlarge</span>
or <span style="font-family: monospace;">cc2.8xlarge</span>&nbsp; for
parallel processing. Each of these instance types can be
launched in a <a href="http://aws.amazon.com/ec2/hpc-applications/">cluster
placement
group</a>, which guarantees a specified bandwidth between
instances.&nbsp; Other instance types cannot (except for the gpu
cluster instance type).&nbsp; <br>
<br>
When <span style="font-style: italic;">cloudRmpi</span>
launches a network of <span style="font-family: monospace;"></span>instances
that
can
run
in
a
cluster,
those
instances
are
always
put
into
a
placement
group.&nbsp;&nbsp;
This
provides
the
fastest
network
communications
available
from
AWS.&nbsp;
According
to
Amazon,
cluster
placement
groups
are
intended for hpc.<br>
<br>
<h3><a name="5._Costs"></a>5. Costs</h3>
There are no sunk costs when using EC2 (or in creating or maintaining
an
AWS account); charges are strictly&nbsp; based on usage. The main costs
are the <a href="http://aws.amazon.com/ec2/pricing/">hourly
instance charges</a>, which vary with the instance type.&nbsp; AWS also
charges for data transfers in and out of EC2 instances (see the "Data
Transfer" section of <a href="http://aws.amazon.com/ec2/pricing/">Amazon
EC2
Pricing</a>), although transfer charges are usually small compared to
instance
charges.&nbsp; There is no charge for data tranfers between instances
in the same 'region'.<span class="normal_link"> In addition, we now
charge $0.03 </span>for use of our most recent
machine images (AMIs).&nbsp; <br>
<span class="normal_link"><br>
</span>
<h3><a name="6._Security"></a>6. Security</h3>
<br>
Since EC2 is a web base service, security is inevitably a
concern.&nbsp; Following is a brief description of security associated
with <span style="font-style: italic;">cloudRmpi</span>.<br>
<br>
The <span style="font-style: italic;">cloudRmpi</span> network manager<span
 style="font-style: italic;">&nbsp; </span>launches and
manages instances using the <a href="http://aws.amazon.com/sdkforjava/">AWS
SDK
for
Java</a>, which generates commands in the underlying EC2 api,
composed of REST and SOAP commands.&nbsp; By default, all commands are
transmitted using SSL.&nbsp; Commands must include the user's AWS
'Access Key ID' and '<span class="normal_link">Secret Access Key'. <span
 style="font-style: italic;">cloudRmpi</span> reads these strings from
the configuration file </span><span class="normal_link"><span
 style="font-family: monospace;">.ppe-conf </span>in the user's home
directory.&nbsp; This file is <span style="font-style: italic;">en
claire</span>, so it is important that it <span
 style="font-style: italic;">not</span> be publicly accessible.&nbsp;
On Unix systems,</span><span class="normal_link"> this file's
permission bits
should be set to 0600 (e.g. <span style="font-family: monospace;">chmod
0600
.ppe-config</span>). <br>
<br>
EC2 instances are launched within what AWS terms a <a
 href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/using-network-security.html#concepts-security">security
group</a>, which is equivalent to a firewall.&nbsp; By default, <span
 style="font-style: italic;">cloudRmpi</span> creates a one-time
security group and launches instances into that group.&nbsp; The
default security group has the following configuration:<br>
<br>
</span>
<table
 style="border-collapse: collapse; text-align: left; width: 75%; margin-left: auto; margin-right: auto;"
 border="1" cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">From port<br>
      </td>
      <td style="vertical-align: top;">To port<br>
      </td>
      <td style="vertical-align: top;">Protocol<br>
      </td>
      <td style="vertical-align: top;">Accessible from<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">22<br>
      </td>
      <td style="vertical-align: top;">22<br>
      </td>
      <td style="vertical-align: top;">tcp<br>
      </td>
      <td style="vertical-align: top;">All ip addresses<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">1<br>
      </td>
      <td style="vertical-align: top;">21<br>
      </td>
      <td style="vertical-align: top;">tcp<br>
      </td>
      <td style="vertical-align: top;">Group members only<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">23<br>
      </td>
      <td style="vertical-align: top;">65535<br>
      </td>
      <td style="vertical-align: top;">tcp<br>
      </td>
      <td style="vertical-align: top;">Group members only</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">1<br>
      </td>
      <td style="vertical-align: top;">65535</td>
      <td style="vertical-align: top;">udp<br>
      </td>
      <td style="vertical-align: top;">Group members only</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">16020<br>
      </td>
      <td style="vertical-align: top;">16020<br>
      </td>
      <td style="vertical-align: top;">tcp<br>
      </td>
      <td style="vertical-align: top;">All ip addresses<br>
      </td>
    </tr>
  </tbody>
</table>
<span class="normal_link"><br>
In other words, instances within the network have unrestricted access
to each other (which is neccessary for Open MPI), but are only
accessible from the rest of the world via
ssh
(port 22). </span><span class="normal_link">16020 is used to send
messages to a monitor program running on an EC2 instance.</span><br>
<span class="normal_link"><br>
</span><span style="font-style: italic;"></span>Each EC2 instance is
associated the an RSA key.&nbsp; The public portion of this key must be
registered with AWS before instances can be launched; it's name is
specified as part of instance requests. After instances are launched, <span
 style="font-style: italic;">cloudRmpi&nbsp; </span>uses the private
key
to access the instances (via ssh), to perform some setup.&nbsp;&nbsp;<span
 style="font-style: italic;">cloudRmpi</span><span
 style="font-style: italic;">&nbsp; </span>gets the key name
and the path to the keypair file from <span class="normal_link"><span
 style="font-family: monospace;">.ppe-conf. </span>Obviously is it is
important to keep the configuration file and the key pair file
secure.&nbsp; The private key
exists
only on the user's&nbsp; local system.&nbsp; Amazon provides a utility
for creating an RSA keypair and recording the public key, but it does <span
 style="font-style: italic;">not</span> keep a copy of the private key.</span><br>
<span class="normal_link"><br>
</span><span style="font-style: italic;">cloudRmpi</span> instances are
configured to support ssh login using the RSA key only.&nbsp; There are
no passwords.&nbsp; (This is standard practice with EC2
instances.)&nbsp; Each instance has a user named <span
 style="font-family: monospace;">ec2-user.<span
 style="font-style: italic;"><span style="font-family: monospace;"><span
 style="font-style: italic;">&nbsp;</span></span></span></span><span
 style="font-style: italic;"><span style="font-style: italic;">&nbsp; </span></span>The
only
way
to
access
a
node
in
a
<span style="font-style: italic;">cloudRmpi </span>network
is
via
ssh, e.g.<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">ssh
-i
your-rsa-keypair-file.pem
ec2-user@ec2-123-456-789-123.compute-1.amazon.com<br>
<br>
</span></div>
and similarly with <span style="font-family: monospace;">scp</span>. <br>
<br>
<span style="font-style: italic;"></span>Communications between your
local R session and the R session on the master node of the EC2 network
go through a pair of java apps, one on the local system and the other
on the network master node (see <a href="#9._Architecture">Architecture</a>
for details).&nbsp; These java apps perform socket level communication
via ssh port forwarding.&nbsp; So when you use <span
 style="font-family: monospace;"></span>functions like <span
 style="font-family: monospace;">re()</span> or <span
 style="font-family: monospace;">upo()</span> to perform operations in
the remote R session, communications is via ssh.<br
 style="font-family: monospace;">
<br>
<br>
<h3><a name="7._Dependencies"></a>7. Dependencies<br>
</h3>
<span style="font-style: italic;">cloudRmpi</span> depends on two R
packages, <span style="font-style: italic;">digest</span> and <span
 style="font-style: italic;">rreval</span>. It also uses the following
third-party packages:<br>
<ul>
  <li><a href="http://aws.amazon.com/sdkforjava/">AWS SDK for Java</a>&nbsp;



























    <span id="txt">Note that the AWS sdk distribution itself contains
third party software
(see <span style="font-family: monospace;">inst/third-party/aws-java-sdk-1.3.3/third-party</span>
in the <span style="font-style: italic;">cloudRmpi</span> distribution
for details).</span><br>
  </li>
  <li><a href="http://www.ganymed.ethz.ch/ssh2/">Ganymed SSH-2 for Java</a></li>
  <li><a href="http://trove.starlight-systems.com/">GNU Trove: High
performance collections for Java.</a></li>
  <li><a href="http://hc.apache.org/httpcomponents-core-ga/index.html">Apache
Http
Components
Core</a></li>
  <li><a href="http://aws.amazon.com/code/Amazon-FPS/5090796688019801">Amazon
FPS
Java
Library</a><span style="font-style: italic;"></span></li>
</ul>
See the the <span style="font-family: monospace;">third-party
</span>directory in the <span style="font-style: italic;">cloudRmpiJars
</span>package
for
these
packages' licenses.<br>
<br>
We have previously released the network management application in the <a
 href="http://norbl.com/ppe-ompi.html">ppe-ompi</a> project (which is
released under GPL 3.0).<br>
<br>
<br>
<h3><a name="8._Machine_images"></a>8. Machine images</h3>
An EC2 network consists of one or more hosts (termed <a
 href="http://aws.amazon.com/ec2/instance-types/">instances</a> by
Amazon) running a virtualized operating system termed an <a
 href="http://aws.amazon.com/amis/">Amazon Machine
Images</a> (AMI).&nbsp; In addition to the operating system, an AMI can
contain application software and can be configured to launch
applications when booted.<br>
<br>
<a href="http://aws.amazon.com/amis/">Amazon Machine Images</a> (AMIs)
with Open MPI and R installed are listed <a
 href="http://norbl.s3-website-us-east-1.amazonaws.com/Machine_images_cloudrmpi.html">here</a><br>
<span style="font-style: italic;"></span><br>
To use a <a href="http://aws.amazon.com/ec2/hpc-applications/">cluster
placement
group</a>, you must use an image with hmv virtualization.&nbsp;
Otherwise you can use a paravirtual image (see <a
 href="#4._Choosing_an_instance_type">Choosing an instance type</a>).<br>
<br>
These images are configured to start an R session and launch the server
function <span style="font-family: monospace;">rreServer()</span> when
booted.&nbsp; I.e. they are ready to be <span
 style="font-style: italic;"></span>to accept a connection from <span
 style="font-family: monospace;">ppe.startClient()</span> as soon as
the boot process is complete.<br>
<br>
<span class="normal_link"></span><br>
<h3><a name="9._Architecture"></a>9. Architecture</h3>
<span style="font-style: italic;">cloudRmpi</span> has two main
components: the network manager and a client-server mechanism for
evaluating expressions in an R session running on the network's master
MPI node.<br>
<br>
<h4>Network Manager</h4>
The network manager is java app that is launched on the local systemby
the function <span style="font-family: monospace;">ppe.launchNetworkManager().&nbsp;
</span>Communications between the R session and the network manager are
via a socket.&nbsp; The network manager is always launched on the same
system as the local R client.&nbsp; Communications between the R
session and the network manager are <span style="font-style: italic;">en
clair.</span><br>
<br>
The network manage creates a network of EC2 instances using the <a
 href="http://aws.amazon.com/sdkforjava/">AWS
SDK
for Java</a> which sends command to AWS via using SSL. As part of the
request for instances that it submits to AWS, it creates a one&nbsp;
time security group (see <a href="#6._Security">Security</a> for
details).<br>
<br>
After submitting a request for instances, the network manager
continually monitors the status of the request and the status of the
instances once they are launched. Once all instances are available, it
performs the following configuration related operations:<br>
<ul>
  <li>Designates one instance as the MPI master node, and the rest as
slaves.</li>
  <li>Creates a one time RSA keypair and installs it on the
master.&nbsp; The public portion is installed on the slaves. NOTE that
this keypair is used for communications between nodes only and is
completely distinct from the user's keypair.&nbsp; The user's keypair
is used for launching instances and for access to the network.&nbsp;
The private key of your
keypair resides on your local system and is never transferred anywhere.</li>
  <li>Creates an ompi host file, <span style="font-family: monospace;">~ec2-user/ompi-hostfile</span>
on the
master.</li>
  <li>Disables hyperthreading on all instances.<br>
&nbsp; </li>
</ul>
<h4>Remote evaluation, client-server communications</h4>
<span style="font-style: italic;">cloudRmpi</span> uses the <span
 style="font-style: italic;">rreval</span> package to access an R
session on the master MPI node of the EC2 network.&nbsp; <span
 style="font-style: italic;">cloudRmpi </span>has some functions (such
as <span style="font-family: monospace;">ppe.startClient()</span>)
that are&nbsp; essentially wrappers for <span
 style="font-style: italic;">rreval </span>functions; they make using <span
 style="font-family: monospace;">rreval </span>on with an EC2 network
more convenient, but the underlying code is the same.<br>
<br>
<span style="font-style: italic;">rreval</span>
is a means for using R on a
remote system from within a local R session.&nbsp; Any R expression can
be evaluated on the remote server. All non-graphical results are
returned to the local R session: this includes the results of remote
evaluations and (nearly) all textual output, including errors and
warnings.&nbsp; <br>
<br>
Expressions are evaluated by an R session on the MPI master node that
is running
the rreval server. When a local R session conne<span
 style="font-style: italic;"><span style="font-style: italic;"><span
 style="font-style: italic;"><span style="font-style: italic;"></span></span></span></span>cts
to
a
server,
the
local
client
has
exclusive
use
of
the
remote
R
session
until
it
disconnects;
i.e.
an
R
server
handles
only
one
client
at
a
time.<br>
<br>
Communication between the client and server is performed by a pair
of&nbsp; java apps, <span style="font-family: monospace;">rreval.RReClientApp</span><span
 style="font-family: monospace;"> </span>and <span
 style="font-family: monospace;">rreval.RReServerApp. </span>The local
R session sends a command to the <span style="font-family: monospace;">rreval.RReClientApp.&nbsp;
</span>After performing error checks, the command is sent to <span
 style="font-family: monospace;">rreval.RReServerApp</span> which runs
on the remote system. It in turn passes the command to the rreval
server.&nbsp; The results of evaluation are returned by this path in
reverse.<br>
<br>
The two java apps communicate via ssh port forwarding, so communication
between them should be secure.&nbsp; Note that communications between
an R session and a java app are <span style="font-style: italic;">en
clair.</span>&nbsp; These are local socket communications so security
should not an issue.<br>
<br>
<br>
<h3><a name="10._Handling_problems"></a>10. Handling problems</h3>
Handling errors in a parallel processing environment can be messy, and
R parallel processing packages are no exception.&nbsp; For example, if
you use the <span style="font-style: italic;">npRmpi</span> function<br>
<br>
<div style="margin-left: 40px;"><span style="font-family: monospace;">mpi.bcast.cmd(bw.hit
&lt;-
npcdensbw(y
~
x,data=obs),caller.execute=TRUE)</span><br
 style="font-family: monospace;">
</div>
<br>
without first broadcasting <span style="font-family: monospace;">obs</span><span
 style="font-family: monospace;"> (</span>i.e.<span
 style="font-family: monospace;"> mpi.bcast.Robj2slave(obs)</span>),
the call to <span style="font-family: monospace;">npcdensbw</span>
will hang and there's no way to interrupt it.<br>
<br>
Although it sounds crude, the best&nbsp; way we've found to handle this
kind of situation is to simply reboot all the instances in the
network.&nbsp; The network manager has a command to reboot an entire
network:<br>
<div style="margin-left: 40px;"><img
 style="width: 436px; height: 126px;" alt=""
 src="terminate_reboot_detail.png"><br>
</div>
<br>
Of course you will loose everything in your remote R session.&nbsp; We
usually make liberal use of <span style="font-family: monospace;">re(save.image()).
</span>When you reboot a EC2 instance, anything you've written to disk
is preserved (which is <span style="font-style: italic;">not</span>
the case when you terminate an instance).&nbsp; It's not a terribly
elegant solution, but it's the best we've come up with so far.<br>
<br>
</div>
</body>
</html>
